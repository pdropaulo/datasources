WITH PROCESSO_P AS (
	SELECT P1.SEQ_PROCESSO,
		--P1.SEQ_ASSUNTO,
		AC.DSC_ASSUNTO_CATEG,
		A.DSC_ASSUNTO,
--P.DSC_PROCESSO,
		CONCAT(LPAD(P1.NUM_NUMERO, 8, '0'), CONCAT('/', P1.NUM_ANO)) AS NUMEROPROCESSO
		FROM TRAMITA.PROCESSO p1
		INNER JOIN TRAMITA.ASSUNTO A 
		ON (P1.SEQ_ASSUNTO = A.SEQ_ASSUNTO)
		INNER JOIN TRAMITA.ASSUNTO_CATEG ac 
		ON (A.SEQ_ASSUNTO_CATEG = AC.SEQ_ASSUNTO_CATEG)
),
DISTRIBUICAO AS (
	SELECT *
	FROM
		(SELECT PROCESSO_P.*,
		--M.SEQ_MOVIMENTACAO,
		M.SEQ_PROCESSO AS SEQPROCESSO,
--M.DSC_OBSERVACAO,
--P.SEQ_USUARIO_AUTOR,
--P.SEQ_USUARIO_REPRESENTANTE,
		M.SEQ_USUARIO,
		TO_DATE(TO_CHAR(M.DAT_CRIACAO, 'DD/MM/YYYY'), 'DD/MM/YYYY') AS DATADISTRIBUICAO,
		RANK() OVER(PARTITION BY M.SEQ_PROCESSO ORDER BY M.DAT_CRIACAO ASC) RK,
		CASE
			WHEN EXTRACT(MONTH FROM M.DAT_CRIACAO) = 1 OR EXTRACT(MONTH FROM M.DAT_CRIACAO) = 2 THEN '1º BIMESTRE'  
			WHEN EXTRACT(MONTH FROM M.DAT_CRIACAO) = 3 OR EXTRACT(MONTH FROM M.DAT_CRIACAO) = 4 THEN '2º BIMESTRE'
			WHEN EXTRACT(MONTH FROM M.DAT_CRIACAO) = 5 OR EXTRACT(MONTH FROM M.DAT_CRIACAO) = 6 THEN '3º BIMESTRE'
			WHEN EXTRACT(MONTH FROM M.DAT_CRIACAO) = 7 OR EXTRACT(MONTH FROM M.DAT_CRIACAO) = 8 THEN '4º BIMESTRE'
			WHEN EXTRACT(MONTH FROM M.DAT_CRIACAO) = 9 OR EXTRACT(MONTH FROM M.DAT_CRIACAO) = 10 THEN '5º BIMESTRE'
			WHEN EXTRACT(MONTH FROM M.DAT_CRIACAO) = 11 OR EXTRACT(MONTH FROM M.DAT_CRIACAO) = 12 THEN '6º BIMESTRE'
			ELSE NULL
		END	AS BIMESTRE	
		FROM TRAMITA.MOVIMENTACAO m 
		INNER JOIN PROCESSO_P 
		ON (M.SEQ_PROCESSO = PROCESSO_P.SEQ_PROCESSO)
		WHERE M.SEQ_SITUACAO = 21 --indica distribuição
		AND M.COD_LOTACAO = 10302004 --codigo da ceges
		)
	WHERE RK = 1 --pega o primeiro elemento do RANK, ou seja, o de menor DATA de criacao, ASC 
),
USUARIO_U AS (
	SELECT
	DISTRIBUICAO.*,
	UT.DSC_DOCUMENTO
	FROM TRAMITA.USUARIO_TRAMITA ut 
	INNER JOIN DISTRIBUICAO
	ON (DISTRIBUICAO.SEQ_USUARIO = UT.SEQ_USUARIO)
),
ASSINATURA_A AS (
	SELECT CASE 
		WHEN A.DAT_ASSINADO IS NOT NULL THEN TO_CHAR(CAST(A.DAT_ASSINADO AS DATE))
		ELSE 'NÃO ASSINADO'
	END AS DATA_ASSINATURA, 
	--A.DAT_ASSINADO,
	--A.SEQ_DOCUMENTO,
	D.SEQ_PROCESSO AS SEQP
	FROM TRAMITA.ASSINATURA a 
	INNER JOIN TRAMITA.DOCUMENTO d -- ANTES LEFT, ALGUMA DIFERENÇA NESSE CASO?!
	ON (A.SEQ_DOCUMENTO = D.SEQ_DOCUMENTO)
	WHERE D.NUM_ORDEM = 1 --numero de ordem q acredito ser a ordem de geração dos documentos, será?!
)
SELECT USUARIO_U.*, ASSINATURA_A.*, U.NOM_USUARIO
FROM USUARIO_U
INNER JOIN SISSEG.USUARIO U
ON (U.NUM_MATRICULA = USUARIO_U.DSC_DOCUMENTO)
INNER JOIN ASSINATURA_A --ANTES LEFT, POSSUÍA DOIS VALORES NULL EM DATA_ASSINATRUA. 
ON (USUARIO_U.SEQPROCESSO = ASSINATURA_A.SEQP)
WHERE U.COD_ORGAO_LOCAL = 10302004 --seleciona apenas usuarios da ceges
