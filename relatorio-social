WITH SORTEIO AS (
	SELECT DISTINCT NSP.ID_SORTEIO, 
		NSP.ID_INSTITUICAO,
		SUM(CASE WHEN NSP.TP_PAGAMENTO = 'IR' THEN NSP.VL_PREMIACAO_INSTITUICAO
			 WHEN NSP.TP_PAGAMENTO = 'IA' THEN NSP.VL_PREMIACAO_INSTITUICAO
			 END) AS TOTAL_PAG,
		--NSP.VL_PREMIACAO_INSTITUICAO,
		--NSP.TP_PAGAMENTO, --IA REPRESENTA O RATEIO 30%, ENQUANTO IR, O RATEIO 70%
		--NSP.TM_PAGAMENTO, --TODOS OS VALORES SÃO NULL, O QUE INDICA Q NÃO HOUVE PAGAMENTO
		--NSP.ST_PAGAMENTO, --COMPROVA QUE AS INSTITUIÇÕES AGUARDAM PAGAMENTO (AG) 
		NI.NU_CNPJ,
		NI.NM_INSTITUICAO 
	FROM SUANOTA.NFP_SORTEIO_PAGAMENTO NSP
	LEFT JOIN SUANOTA.SNTV_BALANCO_SOCIAL SBS 
	ON (NSP.ID_INSTITUICAO = SBS.SEQ_INSTITUICAO)
	INNER JOIN SUANOTA.NFP_INSTITUICAO NI 
	ON (NSP.ID_INSTITUICAO = NI.ID_INSTITUICAO)
	WHERE NSP.ID_SORTEIO IN (36, 37, 38, 39, 40)
	AND SBS.SEQ_INSTITUICAO IS NOT NULL
	GROUP BY NSP.ID_SORTEIO, NSP.ID_INSTITUICAO, NI.NU_CNPJ, NI.NM_INSTITUICAO--, NSP.ST_PAGAMENTO
), 
BALANCO AS (
	SELECT DISTINCT * 
	FROM (
		SELECT SBS.SEQ_INSTITUICAO,
			SBS.DAT_INICIO,
			RANK() OVER(PARTITION BY SBS.SEQ_INSTITUICAO ORDER BY SBS.DAT_INICIO DESC) AS RK01
		FROM SUANOTA.SNTV_BALANCO_SOCIAL SBS
	)
	WHERE DAT_INICIO BETWEEN TO_DATE('2020-01-01', 'YYYY-MM-DD') AND TO_DATE('2023-06-30', 'YYYY-MM-DD') --INÍCIO DO PROGRAMA ATÉ PERÍODO MÁXIMO CONSIDERADO
	--WHERE RK01 = 1 OR RK01 = 2
),
SEMESTRE AS (
	SELECT  DISTINCT BALANCO.*, 
		CASE
		-- caso 1: não entregou nenhum dos relatórios
		WHEN BALANCO.RK01 = 1 AND BALANCO.DAT_INICIO < TO_DATE('2022-07-01', 'YYYY-MM-DD') THEN 'NÃO ENTREGOU NENHUM'
		-- caso 2: entregou ambos os relatórios
		WHEN BALANCO.RK01 = 1 AND BALANCO.DAT_INICIO BETWEEN TO_DATE('2023-01-01', 'YYYY-MM-DD') AND TO_DATE('2023-06-30', 'YYYY-MM-DD') THEN
			CASE 
				WHEN EXISTS (SELECT  
					CASE 
						WHEN B2.DAT_INICIO BETWEEN TO_DATE('2022-07-01', 'YYYY-MM-DD') AND TO_DATE('2022-12-31', 'YYYY-MM-DD') THEN 1
						ELSE 0
					END
				FROM BALANCO B2 WHERE B2.SEQ_INSTITUICAO = BALANCO.SEQ_INSTITUICAO AND B2.RK01 = 2) THEN 'ENTREGOU 2023.1 E 2022.2'
				ELSE 'FALTA 2022.2'
			END
		-- caso 3: falta 2023.1
		WHEN EXISTS (SELECT B2.RK01 FROM BALANCO B2 WHERE B2.SEQ_INSTITUICAO = BALANCO.SEQ_INSTITUICAO
						AND B2.DAT_INICIO NOT BETWEEN TO_DATE('2023-01-01', 'YYYY-MM-DD') AND TO_DATE('2023-06-30', 'YYYY-MM-DD')
						AND B2.RK01 IN (SELECT B3.RK01 FROM BALANCO B3
								WHERE B3.SEQ_INSTITUICAO = B2.SEQ_INSTITUICAO 
								AND B3.RK01 = 1)) THEN 'FALTA 2023.1'
			ELSE NULL 
		END AS SEMESTRE
	FROM BALANCO
)
SELECT DISTINCT SORTEIO.*,
	--BALANCO.*,
	SEMESTRE.*
	FROM SORTEIO 
	LEFT JOIN SEMESTRE
	ON (SORTEIO.ID_INSTITUICAO = SEMESTRE.SEQ_INSTITUICAO)
	WHERE SEMESTRE.SEMESTRE IS NOT NULL
	AND SEMESTRE.RK01 = 1
	--WHERE SORTEIO.ID_INSTITUICAO = 3372 --CASO DE TESTE
	--WHERE SEMESTRE.DAT_INICIO = TO_DATE('2023-07-01', 'YYYY-MM-DD') --TESTE INSTITUICOES QUE ENTREGARAM 2023.2
